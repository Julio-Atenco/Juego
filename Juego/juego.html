<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combate con Espadas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: white;
        }

        .indicadores {
            display: flex;
            justify-content: space-between;
            width: 1200px;
            margin-bottom: 20px;
            gap: 20px;
        }

        .info-jugador, .info-enemigo {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            flex: 1;
            backdrop-filter: blur(10px);
        }

        .contenedor-barra-vida {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            height: 25px;
            overflow: hidden;
            margin-top: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .barra-vida {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .barra-vida.baja {
            background: linear-gradient(90deg, #f44336 0%, #ff5722 100%);
        }

        .contenedor-canva {
            position: relative;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border-radius: 10px;
        }

        canvas {
            background: linear-gradient(180deg, #87CEEB 0%, #98D8C8 60%, #8B7355 100%);
            border: 4px solid rgba(255, 255, 255, 0.2);
            display: block;
        }

        .info-controles {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            width: 1200px;
        }

        .rejilla-controles {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 10px;
        }

        .elemento-control {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }

        .tecla {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
            margin-right: 5px;
            font-size: 14px;
        }

        .pantalla-fin-juego {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .pantalla-fin-juego.mostrar {
            display: flex;
        }

        .mensaje-fin-juego {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            animation: aparecer 0.5s ease;
        }

        @keyframes aparecer {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .mensaje-fin-juego h2 {
            font-size: 3.5em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.5);
        }

        button {
            padding: 15px 40px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            background: white;
            color: #667eea;
            transition: transform 0.3s ease;
        }

        button:hover {
            transform: scale(1.05);
        }

        .enfriamiento-escudo {
            margin-top: 10px;
            font-size: 14px;
            opacity: 0.8;
        }

        .efecto-estado {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 5px;
            margin-top: 5px;
            font-size: 12px;
            font-weight: bold;
        }

        .escudo-activo {
            background: #2196F3;
            color: white;
        }

        .defensa-activa {
            background: #FF9800;
            color: white;
        }

        .estadisticas {
            margin-top: 10px;
            font-size: 14px;
            color: #ccc;
        }
    </style>
</head>
<body>
    <div class="indicadores">
        <div class="info-jugador">
            <h3>JUGADOR</h3>
            <div class="contenedor-barra-vida">
                <div class="barra-vida" id="vidaJugador">100 PV</div>
            </div>
            <div class="enfriamiento-escudo" id="enfriamientoEscudo">Escudo: Listo</div>
            <div id="estadoJugador"></div>
            <div class="estadisticas">
                Victorias: <span id="victorias">0</span> | Derrotas: <span id="derrotas">0</span>
            </div>
        </div>
        <div class="info-enemigo">
            <h3>ENEMIGO</h3>
            <div class="contenedor-barra-vida">
                <div class="barra-vida" id="vidaEnemigo">150 PV</div>
            </div>
            <div id="estadoEnemigo"></div>
        </div>
    </div>

    <div class="contenedor-canva">
        <canvas id="canvaJuego" width="1200" height="500"></canvas>
    </div>

    <div class="info-controles">
        <h3>CONTROLES</h3>
        <div class="rejilla-controles">
            <div class="elemento-control">
                <span class="tecla">A / Flecha Izq</span> Mover Izquierda
            </div>
            <div class="elemento-control">
                <span class="tecla">D / Flecha Der</span> Mover Derecha
            </div>
            <div class="elemento-control">
                <span class="tecla">W</span> Saltar
            </div>
            <div class="elemento-control">
                <span class="tecla">F</span> Escudo / Bloqueo (2s enfriamiento)
            </div>
            <div class="elemento-control">
                <span class="tecla">CLICK IZDO</span> Atacar con Espada
            </div>
            <div class="elemento-control">
                <span class="tecla">R</span> Reiniciar Juego
            </div>
        </div>
    </div>

    <div class="pantalla-fin-juego" id="pantallaFinJuego">
        <div class="mensaje-fin-juego">
            <h2 id="textoFinJuego"></h2>
            <button onclick="reiniciarJuego()">Jugar de Nuevo</button>
        </div>
    </div>

    <!-- Música de fondo -->
    <audio id="musicaFondo" src="Get This Back [xv8tICN8M7w].mp3" loop autoplay style="display:none"></audio>

    <script>
        const canva = document.getElementById('canvaJuego');
        const ctx = canva.getContext('2d');

        let juegoActivo = true;
        let teclas = {};

        // Configuración física
        const GRAVEDAD = 0.8;
        const VELOCIDAD_SALTO = -16;
        const SUELO_Y = 400;

        // Jugador
        const jugador = {
            x: 100,
            y: SUELO_Y - 40,
            ancho: 40,
            alto: 40,
            velocidadX: 0,
            velocidadY: 0,
            velocidadHorizontal: 6,
            enSuelo: true,
            color: '#2196F3',
            atacandoEspada: false,
            anguloEspada: 0,
            escudoActivo: false,
            enfriamientoEscudo: 0,
            duracionEscudo: 0,
            vida: 100
        };

        // Enemigo
        const enemigo = {
            x: 1100,
            y: SUELO_Y - 40,
            ancho: 50,
            alto: 50,
            velocidadX: 0,
            velocidadY: 0,
            velocidadHorizontal: 3,
            enSuelo: true,
            color: '#f44336',
            atacandoEspada: false,
            anguloEspada: 0,
            enfriamientoAtaque: 0,
            temporizadorMovimiento: 0,
            direccionMovimiento: -1,
            defensaActiva: false,
            enfriamientoDefensa: 0,
            temporizadorDefensa: 0,
            vida: 150
        };

        // === LOCALSTORAGE: Estadísticas persistentes ===
        const ESTADISTICAS_CLAVE = 'combateEspadas_estadisticas';
        let estadisticas = {
            victorias: 0,
            derrotas: 0,
            partidasJugadas: 0,
            mejorTiempoVictoria: null,
            ultimaPartida: null
        };

        function cargarEstadisticas() {
            const guardado = localStorage.getItem(ESTADISTICAS_CLAVE);
            if (guardado) {
                try {
                    const datos = JSON.parse(guardado);
                    estadisticas = { ...estadisticas, ...datos };
                } catch (e) {
                    console.warn("Error al cargar estadísticas, se reinician.");
                }
            }
            actualizarContadores();
        }

        function guardarEstadisticas() {
            localStorage.setItem(ESTADISTICAS_CLAVE, JSON.stringify(estadisticas));
        }

        function actualizarContadores() {
            document.getElementById('victorias').textContent = estadisticas.victorias;
            document.getElementById('derrotas').textContent = estadisticas.derrotas;
        }

        function registrarVictoria() {
            estadisticas.victorias++;
            estadisticas.partidasJugadas++;
            estadisticas.ultimaPartida = new Date().toLocaleString();
            guardarEstadisticas();
            actualizarContadores();
        }

        function registrarDerrota() {
            estadisticas.derrotas++;
            estadisticas.partidasJugadas++;
            estadisticas.ultimaPartida = new Date().toLocaleString();
            guardarEstadisticas();
            actualizarContadores();
        }

        // Controles
        document.addEventListener('keydown', (e) => {
            teclas[e.key.toLowerCase()] = true;

            if (e.key === 'f' && !jugador.escudoActivo && jugador.enfriamientoEscudo <= 0 && juegoActivo) {
                activarEscudo();
            }

            if (e.key.toLowerCase() === 'r') {
                reiniciarJuego();
            }
        });

        document.addEventListener('keyup', (e) => {
            teclas[e.key.toLowerCase()] = false;
        });

        // Salto
        document.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'w' && jugador.enSuelo && juegoActivo) {
                e.preventDefault();
                jugador.velocidadY = VELOCIDAD_SALTO;
                jugador.enSuelo = false;
            }
        });

        // Ataque con click
        canva.addEventListener('click', (e) => {
            if (juegoActivo && !jugador.atacandoEspada) {
                ataqueJugador();
            }
        });

        function activarEscudo() {
            jugador.escudoActivo = true;
            jugador.duracionEscudo = 30;
            jugador.enfriamientoEscudo = 90;
            document.getElementById('estadoJugador').innerHTML = '<span class="efecto-estado escudo-activo">ESCUDO ACTIVO</span>';
        }

        function ataqueJugador() {
            jugador.atacandoEspada = true;
            jugador.anguloEspada = 0;
            
            setTimeout(() => {
                verificarGolpeJugador();
                jugador.atacandoEspada = false;
            }, 200);
        }

        function verificarGolpeJugador() {
            const alcanceEspada = 70;
            const dx = Math.abs(jugador.x - enemigo.x);
            const dy = Math.abs(jugador.y - enemigo.y);
            
            if (dx < alcanceEspada && dy < 60) {
                let daño = Math.floor(Math.random() * 10) + 15;
                
                if (enemigo.defensaActiva) {
                    daño = Math.floor(daño * 0.3);
                    document.getElementById('estadoEnemigo').innerHTML = '<span class="efecto-estado defensa-activa">DEFENDIENDO</span>';
                    setTimeout(() => {
                        document.getElementById('estadoEnemigo').innerHTML = '';
                    }, 500);
                }
                
                enemigo.vida = Math.max(0, enemigo.vida - daño);
                actualizarBarrasVida();
                verificarFinJuego();
            }
        }

        function fisicaJugador() {
            jugador.velocidadX = 0;
            if (teclas['a'] || teclas['arrowleft']) jugador.velocidadX = -jugador.velocidadHorizontal - 7;
            if (teclas['d'] || teclas['arrowright']) jugador.velocidadX = jugador.velocidadHorizontal + 7;

            if (!jugador.enSuelo) {
                jugador.velocidadY += GRAVEDAD;
            }

            jugador.x += jugador.velocidadX;
            jugador.y += jugador.velocidadY;

            if (jugador.y >= SUELO_Y - jugador.alto) {
                jugador.y = SUELO_Y - jugador.alto;
                jugador.velocidadY = 0;
                jugador.enSuelo = true;
            }

            jugador.x = Math.max(0, Math.min(canva.width - jugador.ancho, jugador.x));
            jugador.y = Math.max(0, Math.min(canva.height - jugador.alto, jugador.y));
        }

        function iaEnemigo() {
            if (!juegoActivo) return;

            enemigo.enfriamientoAtaque--;
            enemigo.enfriamientoDefensa--;
            enemigo.temporizadorMovimiento--;
            enemigo.temporizadorDefensa--;

            if (enemigo.temporizadorDefensa <= 0 && Math.random() < 0.012) {
                enemigo.defensaActiva = true;
                enemigo.temporizadorDefensa = 45;
                enemigo.enfriamientoDefensa = 120;
            }

            if (enemigo.defensaActiva && enemigo.temporizadorDefensa > 0) {
                enemigo.temporizadorDefensa--;
                if (enemigo.temporizadorDefensa <= 0) {
                    enemigo.defensaActiva = false;
                }
            }

            if (enemigo.temporizadorMovimiento <= 0) {
                const distanciaX = jugador.x - enemigo.x;
                if (Math.abs(distanciaX) < 20000) {
                    enemigo.direccionMovimiento = distanciaX > 0 ? 1 : -1;
                } else {
                    if (Math.random() < 0.3) {
                        enemigo.direccionMovimiento *= -1;
                    }
                }
                enemigo.temporizadorMovimiento = Math.floor(Math.random() * 120) + 60;
            }

            enemigo.velocidadX = enemigo.direccionMovimiento * enemigo.velocidadHorizontal;

            if (!enemigo.enSuelo) {
                enemigo.velocidadY += GRAVEDAD;
            }

            enemigo.x += enemigo.velocidadX;
            enemigo.y += enemigo.velocidadY;

            if (enemigo.y >= SUELO_Y - enemigo.alto) {
                enemigo.y = SUELO_Y - enemigo.alto;
                enemigo.velocidadY = 0;
                enemigo.enSuelo = true;
            }

            enemigo.x = Math.max(0, Math.min(canva.width - enemigo.ancho, enemigo.x));
            enemigo.y = Math.max(0, Math.min(canva.height - enemigo.alto, enemigo.y));

            const distanciaX = Math.abs(jugador.x - enemigo.x);
            const distanciaY = Math.abs(jugador.y - enemigo.y);
            if (distanciaX < 130 && distanciaY < 60 && enemigo.enSuelo && jugador.enSuelo && enemigo.enfriamientoAtaque <= 0 && !enemigo.atacandoEspada) {
                ataqueEnemigo();
            }
        }

        function ataqueEnemigo() {
            enemigo.atacandoEspada = true;
            enemigo.anguloEspada = 0;
            enemigo.enfriamientoAtaque = 65;
            
            setTimeout(() => {
                verificarGolpeEnemigo();
                enemigo.atacandoEspada = false;
            }, 300);
        }

        function verificarGolpeEnemigo() {
            const alcanceEspada = 130;
            const dx = Math.abs(jugador.x - enemigo.x);
            const dy = Math.abs(jugador.y - enemigo.y);
            
            if (dx < alcanceEspada && dy < 60) {
                if (jugador.escudoActivo) {
                    document.getElementById('estadoJugador').innerHTML = '<span class="efecto-estado" style="background: #FFD700; color: #000;">BLOQUEO!</span>';
                    setTimeout(() => {
                        if (!jugador.escudoActivo) {
                            document.getElementById('estadoJugador').innerHTML = '';
                        }
                    }, 500);
                    
                    setTimeout(() => {
                        const daño = Math.floor(Math.random() * 15) + 40;
                        enemigo.vida = Math.max(0, enemigo.vida - daño);
                        actualizarBarrasVida();
                        verificarFinJuego();
                    }, 100);
                } else {
                    const daño = Math.floor(Math.random() * 8) + 30;
                    jugador.vida = Math.max(0, jugador.vida - daño);
                    actualizarBarrasVida();
                    verificarFinJuego();
                }
            }
        }

        function dibujarSuelo() {
            ctx.fillStyle = '#8B7355';
            ctx.fillRect(0, SUELO_Y, canva.width, canva.height - SUELO_Y);
            ctx.strokeStyle = '#6B5344';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(0, SUELO_Y);
            ctx.lineTo(canva.width, SUELO_Y);
            ctx.stroke();
        }

        function dibujarJugador() {
            ctx.fillStyle = jugador.color;
            ctx.fillRect(jugador.x, jugador.y, jugador.ancho, jugador.alto);
            ctx.strokeStyle = '#1976D2';
            ctx.lineWidth = 3;
            ctx.strokeRect(jugador.x, jugador.y, jugador.ancho, jugador.alto);

            ctx.save();
            ctx.translate(jugador.x + jugador.ancho / 2, jugador.y + jugador.alto / 2);
            if (jugador.atacandoEspada) {
                jugador.anguloEspada += 15;
                ctx.rotate((jugador.anguloEspada * Math.PI) / 180);
            }
            ctx.fillStyle = '#C0C0C0';
            ctx.fillRect(20, -3, 30, 6);
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(15, -5, 8, 10);
            ctx.restore();

            if (jugador.escudoActivo) {
                ctx.save();
                ctx.translate(jugador.x + jugador.ancho / 2, jugador.y + jugador.alto / 2);
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(0, 0, 35, 0, Math.PI * 2);
                ctx.stroke();
                ctx.strokeStyle = '#2196F3';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(0, 0, 30, 0, Math.PI * 2);
                ctx.stroke();
                ctx.restore();
            }
        }

        function dibujarEnemigo() {
            ctx.fillStyle = enemigo.color;
            ctx.fillRect(enemigo.x, enemigo.y, enemigo.ancho, enemigo.alto);
            ctx.strokeStyle = '#D32F2F';
            ctx.lineWidth = 3;
            ctx.strokeRect(enemigo.x, enemigo.y, enemigo.ancho, enemigo.alto);

            ctx.save();
            ctx.translate(enemigo.x + enemigo.ancho / 2, enemigo.y + enemigo.alto / 2);
            if (enemigo.atacandoEspada) {
                enemigo.anguloEspada += 15;
                ctx.rotate((enemigo.anguloEspada * Math.PI) / 180);
            }
            ctx.fillStyle = '#000F00';
            ctx.fillRect(-100, -3, 80, 6);
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(-23, -5, 8, 10);
            ctx.restore();

            if (enemigo.defensaActiva) {
                ctx.save();
                ctx.translate(enemigo.x + enemigo.ancho / 2, enemigo.y + enemigo.alto / 2);
                ctx.strokeStyle = '#FF9800';
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.arc(0, 0, 38, 0, Math.PI * 2);
                ctx.stroke();
                ctx.strokeStyle = '#f44336';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(0, 0, 32, 0, Math.PI * 2);
                ctx.stroke();
                ctx.restore();
            }
        }

        function actualizarBarrasVida() {
            const barraJugador = document.getElementById('vidaJugador');
            const barraEnemigo = document.getElementById('vidaEnemigo');

            const porcentajeJugador = (jugador.vida / 100) * 100;
            const porcentajeEnemigo = (enemigo.vida / 150) * 100;

            barraJugador.style.width = porcentajeJugador + '%';
            barraJugador.textContent = jugador.vida + ' PV';
            barraEnemigo.style.width = porcentajeEnemigo + '%';
            barraEnemigo.textContent = enemigo.vida + ' PV';

            if (porcentajeJugador <= 30) barraJugador.classList.add('baja');
            else barraJugador.classList.remove('baja');
            if (porcentajeEnemigo <= 30) barraEnemigo.classList.add('baja');
            else barraEnemigo.classList.remove('baja');
        }

        function verificarFinJuego() {
            if (jugador.vida <= 0) {
                juegoActivo = false;
                registrarDerrota();
                mostrarFinJuego('DERROTA');
            } else if (enemigo.vida <= 0) {
                juegoActivo = false;
                registrarVictoria();
                mostrarFinJuego('¡VICTORIA!');
            }
        }

        function mostrarFinJuego(texto) {
            document.getElementById('textoFinJuego').textContent = texto;
            document.getElementById('pantallaFinJuego').classList.add('mostrar');
        }

        function reiniciarJuego() {
            jugador.x = 100;
            jugador.y = SUELO_Y - 40;
            jugador.vida = 100;
            jugador.velocidadX = 0;
            jugador.velocidadY = 0;
            jugador.enSuelo = true;
            jugador.atacandoEspada = false;
            jugador.escudoActivo = false;
            jugador.enfriamientoEscudo = 0;

            enemigo.x = 1100;
            enemigo.y = SUELO_Y - 40;
            enemigo.vida = 150;
            enemigo.velocidadX = 0;
            enemigo.velocidadY = 0;
            enemigo.enSuelo = true;
            enemigo.atacandoEspada = false;
            enemigo.defensaActiva = false;
            enemigo.enfriamientoAtaque = 0;
            enemigo.direccionMovimiento = -1;

            juegoActivo = true;
            actualizarBarrasVida();
            document.getElementById('pantallaFinJuego').classList.remove('mostrar');
            document.getElementById('enfriamientoEscudo').textContent = 'Escudo: Listo';
            document.getElementById('estadoJugador').innerHTML = '';
            document.getElementById('estadoEnemigo').innerHTML = '';
        }

        // Música
        const musicaFondo = document.getElementById('musicaFondo');
        musicaFondo.volume = 0.5;

        document.addEventListener('DOMContentLoaded', () => {
            cargarEstadisticas(); // Cargar al iniciar
            musicaFondo.play().catch(() => {
                const reproducirAlInteractuar = () => {
                    musicaFondo.play();
                    document.removeEventListener('keydown', reproducirAlInteractuar);
                    document.removeEventListener('mousedown', reproducirAlInteractuar);
                };
                document.addEventListener('keydown', reproducirAlInteractuar);
                document.addEventListener('mousedown', reproducirAlInteractuar);
            });
        });

        function bucleJuego() {
            ctx.clearRect(0, 0, canva.width, canva.height);

            if (juegoActivo) {
                fisicaJugador();
                iaEnemigo();

                if (jugador.enfriamientoEscudo > 0) {
                    jugador.enfriamientoEscudo--;
                    const segundos = (jugador.enfriamientoEscudo / 60).toFixed(1);
                    document.getElementById('enfriamientoEscudo').textContent = `Escudo: ${segundos}s`;
                } else if (!jugador.escudoActivo) {
                    document.getElementById('enfriamientoEscudo').textContent = 'Escudo: Listo';
                }

                if (jugador.duracionEscudo > 0) {
                    jugador.duracionEscudo--;
                    if (jugador.duracionEscudo <= 0) {
                        jugador.escudoActivo = false;
                        document.getElementById('estadoJugador').innerHTML = '';
                    }
                }
            }

            dibujarSuelo();
            dibujarJugador();
            dibujarEnemigo();

            requestAnimationFrame(bucleJuego);
        }

        // Inicializar
        actualizarBarrasVida();
        bucleJuego();
    </script>
</body>
</html>
