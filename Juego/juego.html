<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combate con Espadas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: white;
        }

        .indicadores {
            display: flex;
            justify-content: space-between;
            width: 800px;
            margin-bottom: 20px;
            gap: 20px;
        }

        .info-jugador, .info-enemigo {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            flex: 1;
            backdrop-filter: blur(10px);
        }

        .contenedor-barra-vida {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            height: 25px;
            overflow: hidden;
            margin-top: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .barra-vida {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .barra-vida.baja {
            background: linear-gradient(90deg, #f44336 0%, #ff5722 100%);
        }

        .contenedor-lienzo {
            position: relative;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

        canvas {
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            display: block;
        }

        .info-controles {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            width: 800px;
        }

        .rejilla-controles {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 10px;
        }

        .elemento-control {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }

        .tecla {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
            margin-right: 5px;
            font-size: 14px;
        }

        .pantalla-fin-juego {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .pantalla-fin-juego.mostrar {
            display: flex;
        }

        .mensaje-fin-juego {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            animation: aparecer 0.5s ease;
        }

        @keyframes aparecer {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .mensaje-fin-juego h2 {
            font-size: 3.5em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.5);
        }

        button {
            padding: 15px 40px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            background: white;
            color: #667eea;
            transition: transform 0.3s ease;
        }

        button:hover {
            transform: scale(1.05);
        }

        .enfriamiento-escudo {
            margin-top: 10px;
            font-size: 14px;
            opacity: 0.8;
        }

        .efecto-estado {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 5px;
            margin-top: 5px;
            font-size: 12px;
            font-weight: bold;
        }

        .escudo-activo {
            background: #2196F3;
            color: white;
        }
    </style>
</head>
<body>
    <div class="indicadores">
        <div class="info-jugador">
            <h3>JUGADOR</h3>
            <div class="contenedor-barra-vida">
                <div class="barra-vida" id="vidaJugador">100 PV</div>
            </div>
            <div class="enfriamiento-escudo" id="enfriamientoEscudo">Escudo: Listo</div>
            <div id="estadoJugador"></div>
        </div>
        <div class="info-enemigo">
            <h3>ENEMIGO</h3>
            <div class="contenedor-barra-vida">
                <div class="barra-vida" id="vidaEnemigo">100 PV</div>
            </div>
        </div>
    </div>

    <div class="contenedor-lienzo">
        <canvas id="lienzoJuego" width="800" height="500"></canvas>
    </div>

    <div class="info-controles">
        <h3>CONTROLES</h3>
        <div class="rejilla-controles">
            <div class="elemento-control">
                <span class="tecla">W A S D</span> Mover
            </div>
            <div class="elemento-control">
                <span class="tecla">ESPACIO</span> Atacar con Espada
            </div>
            <div class="elemento-control">
                <span class="tecla">SHIFT</span> Escudo / Bloqueo (2s enfriamiento)
            </div>
            <div class="elemento-control">
                <span class="tecla">R</span> Reiniciar Juego
            </div>
        </div>
    </div>

    <div class="pantalla-fin-juego" id="pantallaFinJuego">
        <div class="mensaje-fin-juego">
            <h2 id="textoFinJuego"></h2>
            <button onclick="reiniciarJuego()">Jugar de Nuevo</button>
        </div>
    </div>

    <!-- Música de fondo -->
    <audio id="musicaFondo" src="musica.mp3" loop autoplay style="display:none"></audio>

    <script>
        const lienzo = document.getElementById('lienzoJuego');
        const ctx = lienzo.getContext('2d');

        let juegoActivo = true;
        let teclas = {};

        // Jugador
        const jugador = {
            x: 100,
            y: 250,
            ancho: 40,
            alto: 40,
            velocidad: 4,
            vida: 100,
            vidaMaxima: 100,
            color: '#2196F3',
            atacandoEspada: false,
            anguloEspada: 0,
            escudoActivo: false,
            enfriamientoEscudo: 0,
            duracionEscudo: 0
        };

        // Enemigo
        const enemigo = {
            x: 660,
            y: 250,
            ancho: 40,
            alto: 40,
            velocidad: 2,
            vida: 100,
            vidaMaxima: 100,
            color: '#f44336',
            atacandoEspada: false,
            anguloEspada: 0,
            enfriamientoAtaque: 0,
            temporizadorMovimiento: 0,
            direccionMovimiento: { x: 0, y: 0 }
        };

        // Controles
        document.addEventListener('keydown', (e) => {
            teclas[e.key.toLowerCase()] = true;
            
            if (e.key === ' ' && !jugador.atacandoEspada && juegoActivo) {
                e.preventDefault();
                ataqueJugador();
            }
            
            if (e.key === 'Shift' && !jugador.escudoActivo && jugador.enfriamientoEscudo <= 0 && juegoActivo) {
                activarEscudo();
            }

            if (e.key.toLowerCase() === 'r') {
                reiniciarJuego();
            }
        });

        document.addEventListener('keyup', (e) => {
            teclas[e.key.toLowerCase()] = false;
        });

        function activarEscudo() {
            jugador.escudoActivo = true;
            jugador.duracionEscudo = 30; // 0.5 segundos
            jugador.enfriamientoEscudo = 120; // 2 segundos
            document.getElementById('estadoJugador').innerHTML = '<span class="efecto-estado escudo-activo">ESCUDO ACTIVO</span>';
        }

        function ataqueJugador() {
            jugador.atacandoEspada = true;
            jugador.anguloEspada = 0;
            
            setTimeout(() => {
                verificarGolpeJugador();
                jugador.atacandoEspada = false;
            }, 200);
        }

        function verificarGolpeJugador() {
            const alcanceEspada = 60;
            const dx = jugador.x - enemigo.x;
            const dy = jugador.y - enemigo.y;
            const distancia = Math.sqrt(dx * dx + dy * dy);
            
            if (distancia < alcanceEspada + enemigo.ancho && !enemigo.atacandoEspada) {
                const daño = Math.floor(Math.random() * 10) + 15;
                enemigo.vida = Math.max(0, enemigo.vida - daño);
                actualizarBarrasVida();
                verificarFinJuego();
            }
        }

        function iaEnemigo() {
            if (!juegoActivo) return;

            enemigo.enfriamientoAtaque--;
            enemigo.temporizadorMovimiento--;

            // Decidir movimiento
            if (enemigo.temporizadorMovimiento <= 0) {
                const dx = jugador.x - enemigo.x;
                const dy = jugador.y - enemigo.y;
                const distancia = Math.sqrt(dx * dx + dy * dy);

                if (distancia > 80) {
                    // Acercarse al jugador
                    enemigo.direccionMovimiento.x = dx > 0 ? 1 : -1;
                    enemigo.direccionMovimiento.y = dy > 0 ? 1 : -1;
                } else if (distancia < 50) {
                    // Alejarse un poco
                    enemigo.direccionMovimiento.x = dx > 0 ? -1 : 1;
                    enemigo.direccionMovimiento.y = dy > 0 ? -1 : 1;
                } else {
                    // Movimiento lateral
                    enemigo.direccionMovimiento.x = Math.random() > 0.5 ? 1 : -1;
                    enemigo.direccionMovimiento.y = Math.random() > 0.5 ? 1 : -1;
                }
                
                enemigo.temporizadorMovimiento = Math.floor(Math.random() * 40) + 30;
            }

            // Mover enemigo
            enemigo.x += enemigo.direccionMovimiento.x * enemigo.velocidad;
            enemigo.y += enemigo.direccionMovimiento.y * enemigo.velocidad;

            // Mantener dentro del lienzo
            enemigo.x = Math.max(0, Math.min(lienzo.width - enemigo.ancho, enemigo.x));
            enemigo.y = Math.max(0, Math.min(lienzo.height - enemigo.alto, enemigo.y));

            // Atacar si está cerca
            const dx = jugador.x - enemigo.x;
            const dy = jugador.y - enemigo.y;
            const distancia = Math.sqrt(dx * dx + dy * dy);

            if (distancia < 100 && enemigo.enfriamientoAtaque <= 0 && !enemigo.atacandoEspada) {
                ataqueEnemigo();
            }
        }

        function ataqueEnemigo() {
            enemigo.atacandoEspada = true;
            enemigo.anguloEspada = 0;
            enemigo.enfriamientoAtaque = 90; // ~1.5 segundos entre ataques
            
            setTimeout(() => {
                verificarGolpeEnemigo();
                enemigo.atacandoEspada = false;
            }, 300);
        }

        function verificarGolpeEnemigo() {
            const alcanceEspada = 60;
            const dx = jugador.x - enemigo.x;
            const dy = jugador.y - enemigo.y;
            const distancia = Math.sqrt(dx * dx + dy * dy);
            
            if (distancia < alcanceEspada + jugador.ancho) {
                if (jugador.escudoActivo) {
                    // ¡BLOQUEO exitoso!
                    document.getElementById('estadoJugador').innerHTML = '<span class="efecto-estado" style="background: #FFD700; color: #000;">¡BLOQUEO!</span>';
                    setTimeout(() => {
                        if (!jugador.escudoActivo) {
                            document.getElementById('estadoJugador').innerHTML = '';
                        }
                    }, 500);
                    
                    // Contraataque después del bloqueo
                    setTimeout(() => {
                        const daño = Math.floor(Math.random() * 15) + 20;
                        enemigo.vida = Math.max(0, enemigo.vida - daño);
                        actualizarBarrasVida();
                        verificarFinJuego();
                    }, 100);
                } else {
                    const daño = Math.floor(Math.random() * 8) + 12;
                    jugador.vida = Math.max(0, jugador.vida - daño);
                    actualizarBarrasVida();
                    verificarFinJuego();
                }
            }
        }

        function moverJugador() {
            if (teclas['w'] || teclas['arrowup']) jugador.y -= jugador.velocidad;
            if (teclas['s'] || teclas['arrowdown']) jugador.y += jugador.velocidad;
            if (teclas['a'] || teclas['arrowleft']) jugador.x -= jugador.velocidad;
            if (teclas['d'] || teclas['arrowright']) jugador.x += jugador.velocidad;

            jugador.x = Math.max(0, Math.min(lienzo.width - jugador.ancho, jugador.x));
            jugador.y = Math.max(0, Math.min(lienzo.height - jugador.alto, jugador.y));
        }

        function dibujarJugador() {
            // Cuerpo del jugador
            ctx.fillStyle = jugador.color;
            ctx.fillRect(jugador.x, jugador.y, jugador.ancho, jugador.alto);
            ctx.strokeStyle = '#1976D2';
            ctx.lineWidth = 3;
            ctx.strokeRect(jugador.x, jugador.y, jugador.ancho, jugador.alto);

            // Espada
            ctx.save();
            ctx.translate(jugador.x + jugador.ancho / 2, jugador.y + jugador.alto / 2);
            
            if (jugador.atacandoEspada) {
                jugador.anguloEspada += 15;
                ctx.rotate((jugador.anguloEspada * Math.PI) / 180);
            }
            
            ctx.fillStyle = '#C0C0C0';
            ctx.fillRect(20, -3, 30, 6);
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(15, -5, 8, 10);
            ctx.restore();

            // Escudo
            if (jugador.escudoActivo) {
                ctx.save();
                ctx.translate(jugador.x + jugador.ancho / 2, jugador.y + jugador.alto / 2);
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(0, 0, 35, 0, Math.PI * 2);
                ctx.stroke();
                ctx.strokeStyle = '#2196F3';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(0, 0, 30, 0, Math.PI * 2);
                ctx.stroke();
                ctx.restore();
            }
        }

        function dibujarEnemigo() {
            // Cuerpo del enemigo
            ctx.fillStyle = enemigo.color;
            ctx.fillRect(enemigo.x, enemigo.y, enemigo.ancho, enemigo.alto);
            ctx.strokeStyle = '#D32F2F';
            ctx.lineWidth = 3;
            ctx.strokeRect(enemigo.x, enemigo.y, enemigo.ancho, enemigo.alto);

            // Espada
            ctx.save();
            ctx.translate(enemigo.x + enemigo.ancho / 2, enemigo.y + enemigo.alto / 2);
            
            if (enemigo.atacandoEspada) {
                enemigo.anguloEspada += 15;
                ctx.rotate((enemigo.anguloEspada * Math.PI) / 180);
            }
            
            ctx.fillStyle = '#C0C0C0';
            ctx.fillRect(20, -3, 30, 6);  // Corregido: espada hacia adelante
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(15, -5, 8, 10);
            ctx.restore();
        }

        function actualizarBarrasVida() {
            const barraJugador = document.getElementById('vidaJugador');
            const barraEnemigo = document.getElementById('vidaEnemigo');

            const porcentajeJugador = (jugador.vida / jugador.vidaMaxima) * 100;
            const porcentajeEnemigo = (enemigo.vida / enemigo.vidaMaxima) * 100;

            barraJugador.style.width = porcentajeJugador + '%';
            barraJugador.textContent = jugador.vida + ' PV';
            barraEnemigo.style.width = porcentajeEnemigo + '%';
            barraEnemigo.textContent = enemigo.vida + ' PV';

            if (porcentajeJugador <= 30) {
                barraJugador.classList.add('baja');
            } else {
                barraJugador.classList.remove('baja');
            }

            if (porcentajeEnemigo <= 30) {
                barraEnemigo.classList.add('baja');
            } else {
                barraEnemigo.classList.remove('baja');
            }
        }

        function verificarFinJuego() {
            if (jugador.vida <= 0) {
                juegoActivo = false;
                mostrarFinJuego('DERROTA');
            } else if (enemigo.vida <= 0) {
                juegoActivo = false;
                mostrarFinJuego('¡VICTORIA!');
            }
        }

        function mostrarFinJuego(texto) {
            document.getElementById('textoFinJuego').textContent = texto;
            document.getElementById('pantallaFinJuego').classList.add('mostrar');
        }

        function reiniciarJuego() {
            jugador.x = 100;
            jugador.y = 250;
            jugador.vida = 100;
            jugador.atacandoEspada = false;
            jugador.escudoActivo = false;
            jugador.enfriamientoEscudo = 0;

            enemigo.x = 660;
            enemigo.y = 250;
            enemigo.vida = 100;
            enemigo.atacandoEspada = false;
            enemigo.enfriamientoAtaque = 0;

            juegoActivo = true;
            actualizarBarrasVida();
            document.getElementById('pantallaFinJuego').classList.remove('mostrar');
            document.getElementById('enfriamientoEscudo').textContent = 'Escudo: Listo';
            document.getElementById('estadoJugador').innerHTML = '';

            // Reiniciar música
            musicaFondo.currentTime = 0;
            musicaFondo.play();
        }

        // Control de música de fondo
        const musicaFondo = document.getElementById('musicaFondo');
        musicaFondo.volume = 0.5;

        // Reproducir música al cargar (con fallback por políticas de autoplay)
        document.addEventListener('DOMContentLoaded', () => {
            musicaFondo.play().catch(() => {
                const reproducirAlInteractuar = () => {
                    musicaFondo.play();
                    document.removeEventListener('keydown', reproducirAlInteractuar);
                    document.removeEventListener('mousedown', reproducirAlInteractuar);
                };
                document.addEventListener('keydown', reproducirAlInteractuar);
                document.addEventListener('mousedown', reproducirAlInteractuar);
            });
        });

        function bucleJuego() {
            ctx.clearRect(0, 0, lienzo.width, lienzo.height);

            if (juegoActivo) {
                moverJugador();
                iaEnemigo();

                // Actualizar enfriamientos
                if (jugador.enfriamientoEscudo > 0) {
                    jugador.enfriamientoEscudo--;
                    const segundos = (jugador.enfriamientoEscudo / 60).toFixed(1);
                    document.getElementById('enfriamientoEscudo').textContent = `Escudo: ${segundos}s`;
                } else if (!jugador.escudoActivo) {
                    document.getElementById('enfriamientoEscudo').textContent = 'Escudo: Listo';
                }

                if (jugador.duracionEscudo > 0) {
                    jugador.duracionEscudo--;
                    if (jugador.duracionEscudo <= 0) {
                        jugador.escudoActivo = false;
                        document.getElementById('estadoJugador').innerHTML = '';
                    }
                }
            }

            dibujarJugador();
            dibujarEnemigo();

            requestAnimationFrame(bucleJuego);
        }

        actualizarBarrasVida();
        bucleJuego();
    </script>
</body>
</html>